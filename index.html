<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#7c3aed">
  <title>Habit Tracker Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    .animate-bounce { animation: bounce 0.5s ease-in-out; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    const TELEGRAM_BOT_TOKEN = '8434385431:AAHsdBYg7-UR9xcVxhGY-hKrfC6e5ZgEDEo';
    const TELEGRAM_CHAT_ID = '-1003297136912';
    const EMOJIS = ['ğŸ’ª', 'ğŸ“š', 'ğŸ§˜', 'ğŸƒ', 'ğŸ’§', 'ğŸ', 'ğŸ˜´', 'ğŸ¨', 'ğŸ¯', 'âœï¸', 'ğŸµ', 'ğŸ§ ', 'â¤ï¸', 'ğŸŒŸ', 'âš¡'];
    const DEFAULT_CELEBRATION_GIF = 'https://media.giphy.com/media/g9582DNuQppxC/giphy.gif';
    
    function HabitTracker() {
      const [habits, setHabits] = useState([]);
      const [newHabit, setNewHabit] = useState('');
      const [selectedEmoji, setSelectedEmoji] = useState('ğŸ¯');
      const [showCelebration, setShowCelebration] = useState(false);
      const [showShame, setShowShame] = useState(false);
      const [celebrationGif, setCelebrationGif] = useState(DEFAULT_CELEBRATION_GIF);
      const [shameGif, setShameGif] = useState('');
      const [username, setUsername] = useState('');
      const [showUsernameModal, setShowUsernameModal] = useState(false);
      const [loading, setLoading] = useState(true);
      const [notificationsEnabled, setNotificationsEnabled] = useState(false);
      const [showNotificationPrompt, setShowNotificationPrompt] = useState(false);

      useEffect(() => {
        loadData();
        checkMissedDays();
        checkWeeklyReport();
        checkNotificationPermission();
      }, []);

      const checkNotificationPermission = () => {
        if ('Notification' in window) {
          setNotificationsEnabled(Notification.permission === 'granted');
          if (Notification.permission === 'default') {
            setTimeout(() => setShowNotificationPrompt(true), 3000);
          }
        }
      };

      const requestNotificationPermission = async () => {
        if ('Notification' in window) {
          const permission = await Notification.requestPermission();
          setNotificationsEnabled(permission === 'granted');
          setShowNotificationPrompt(false);
          
          if (permission === 'granted') {
            sendBrowserNotification('ğŸ‰ Notificaciones activadas', 'RecibirÃ¡s alertas cuando tÃº o tu amigo completen hÃ¡bitos');
          }
        }
      };

      const sendBrowserNotification = (title, body, icon = 'ğŸ¯') => {
        if ('Notification' in window && Notification.permission === 'granted') {
          try {
            const notification = new Notification(title, {
              body: body,
              icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%237c3aed" width="100" height="100"/%3E%3Ctext x="50" y="65" font-size="60" text-anchor="middle"%3E' + icon + '%3C/text%3E%3C/svg%3E',
              vibrate: [200, 100, 200],
              requireInteraction: false
            });
            setTimeout(() => notification.close(), 5000);
            notification.onclick = () => {
              window.focus();
              notification.close();
            };
          } catch (error) {
            console.log('Error mostrando notificaciÃ³n:', error);
          }
        }
      };

      const loadData = () => {
        const storedHabits = localStorage.getItem('habits');
        const storedUsername = localStorage.getItem('username');
        
        if (storedHabits) setHabits(JSON.parse(storedHabits));
        if (storedUsername) setUsername(storedUsername);
        else setShowUsernameModal(true);
        
        setLoading(false);
      };

      const checkMissedDays = () => {
        const lastCheck = localStorage.getItem('lastCheck');
        const today = new Date().toDateString();
        
        if (lastCheck && lastCheck !== today) {
          const storedHabits = localStorage.getItem('habits');
          if (storedHabits) {
            const habits = JSON.parse(storedHabits);
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            const missedHabits = habits.filter(h => {
              if (!h.lastCompleted) return false;
              const lastDate = new Date(h.lastCompleted).toDateString();
              return lastDate !== yesterday && lastDate !== today;
            });
            
            if (missedHabits.length > 0) {
              showFailureAnimation();
              sendBrowserNotification('ğŸ˜¢ Â¡Te saltaste dÃ­as!', `Tienes ${missedHabits.length} hÃ¡bito${missedHabits.length > 1 ? 's' : ''} sin completar`, 'ğŸ˜¢');
            }
          }
        }
        
        localStorage.setItem('lastCheck', today);
      };

      const showFailureAnimation = () => {
        const randomNum = Math.floor(Math.random() * 8) + 1;
        setShameGif(`Failure${randomNum}.gif`);
        setShowShame(true);
        
        const audio = new Audio(`Failure${randomNum}.mp3`);
        audio.play().catch(e => console.log('Error reproduciendo sonido'));
        
        setTimeout(() => setShowShame(false), 4000);
      };

      const checkWeeklyReport = () => {
        const lastReport = localStorage.getItem('lastWeeklyReport');
        const today = new Date();
        const dayOfWeek = today.getDay();
        
        if (dayOfWeek === 0) {
          const todayStr = today.toDateString();
          if (lastReport !== todayStr) {
            sendWeeklyReport();
            localStorage.setItem('lastWeeklyReport', todayStr);
          }
        }
      };

      const sendWeeklyReport = () => {
        const storedHabits = localStorage.getItem('habits');
        if (!storedHabits) return;
        
        const habits = JSON.parse(storedHabits);
        const totalCompleted = habits.reduce((sum, h) => sum + h.completedCount, 0);
        const maxStreak = Math.max(...habits.map(h => h.streak), 0);
        
        let message = `ğŸ“Š REPORTE SEMANAL ğŸ“Š\n\n`;
        message += `ğŸ‘¤ Usuario: ${username || 'AnÃ³nimo'}\n`;
        message += `âœ… Total completados: ${totalCompleted}\n`;
        message += `ğŸ”¥ Racha mÃ¡xima: ${maxStreak} dÃ­as\n\n`;
        message += `HÃ¡bitos activos:\n`;
        habits.forEach(h => {
          message += `${h.emoji} ${h.name}: ${h.streak} dÃ­as ğŸ”¥\n`;
        });
        
        sendTelegramMessage(message);
        sendBrowserNotification('ğŸ“Š Reporte Semanal', `Total: ${totalCompleted} completados | Racha mÃ¡xima: ${maxStreak} dÃ­as`, 'ğŸ“Š');
      };

      const saveUsername = () => {
        if (username.trim()) {
          localStorage.setItem('username', username);
          setShowUsernameModal(false);
          sendTelegramMessage(`ğŸ‘‹ ${username} se ha unido al Habit Tracker!`);
        }
      };

      const saveHabits = (updatedHabits) => {
        localStorage.setItem('habits', JSON.stringify(updatedHabits));
      };

      const sendTelegramMessage = async (message) => {
        try {
          await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              chat_id: TELEGRAM_CHAT_ID,
              text: message,
              parse_mode: 'HTML'
            })
          });
        } catch (error) {
          console.log('Error enviando mensaje:', error);
        }
      };

      const addHabit = () => {
        if (newHabit.trim()) {
          const habit = {
            id: Date.now(),
            name: newHabit,
            emoji: selectedEmoji,
            completedCount: 0,
            lastCompleted: null,
            streak: 0
          };
          const updatedHabits = [...habits, habit];
          setHabits(updatedHabits);
          saveHabits(updatedHabits);
          setNewHabit('');
          
          sendTelegramMessage(`âœ¨ ${username} agregÃ³ un nuevo hÃ¡bito: ${selectedEmoji} ${newHabit}`);
          sendBrowserNotification('âœ¨ Nuevo hÃ¡bito agregado', `${selectedEmoji} ${newHabit}`, 'âœ¨');
        }
      };

      const deleteHabit = (id) => {
        const habit = habits.find(h => h.id === id);
        const updatedHabits = habits.filter(h => h.id !== id);
        setHabits(updatedHabits);
        saveHabits(updatedHabits);
        
        if (habit) {
          sendTelegramMessage(`ğŸ—‘ï¸ ${username} eliminÃ³: ${habit.emoji} ${habit.name}`);
        }
      };

      const getCelebrationMedia = (streak) => {
        if (streak === 3) return { gif: 'Day3.gif', sound: 'Day3.mp3' };
        if (streak === 7) return { gif: 'Day7.gif', sound: 'Day7.mp3' };
        if (streak === 15) return { gif: 'Day15.gif', sound: 'Day15.mp3' };
        if (streak >= 30) return { gif: 'Day30.gif', sound: 'Day30.mp3' };
        return { gif: DEFAULT_CELEBRATION_GIF, sound: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZSA0PWqvn77BdGAg+ltryxHUpBSl+zPLaizsIGGS57OihUBELTKXh8bllHgU2jdXzzn8vBSF1xvDdlEILElyx6OyrWBUIQ5zd8sFuJAU' };
      };

      const completeHabit = (id) => {
        const habit = habits.find(h => h.id === id);
        const updatedHabits = habits.map(h => {
          if (h.id === id) {
            const today = new Date().toDateString();
            const lastDate = h.lastCompleted ? new Date(h.lastCompleted).toDateString() : null;
            const isNewDay = today !== lastDate;
            const newStreak = isNewDay ? h.streak + 1 : h.streak;
            
            return { ...h, completedCount: h.completedCount + 1, lastCompleted: Date.now(), streak: newStreak };
          }
          return h;
        });

        setHabits(updatedHabits);
        saveHabits(updatedHabits);

        if (habit) {
          const newStreak = habit.streak + 1;
          const media = getCelebrationMedia(newStreak);
          
          setCelebrationGif(media.gif);
          setShowCelebration(true);
          new Audio(media.sound).play().catch(e => console.log('Error'));
          setTimeout(() => setShowCelebration(false), 3000);

          let message = `ğŸ‰ ${username} completÃ³: ${habit.emoji} ${habit.name}\nğŸ”¥ Racha: ${newStreak} dÃ­a${newStreak !== 1 ? 's' : ''}`;
          let specialMsg = '';
          
          if (newStreak === 3) specialMsg = '\nğŸ¥‰ Â¡TRES DÃAS SEGUIDOS!';
          if (newStreak === 7) specialMsg = '\nğŸ† Â¡UNA SEMANA COMPLETA!';
          if (newStreak === 15) specialMsg = '\nğŸ’ Â¡DOS SEMANAS IMPRESIONANTES!';
          if (newStreak === 30) specialMsg = '\nğŸŒŸ Â¡UN MES INCREÃBLE!';
          if (newStreak === 100) specialMsg = '\nğŸ‘‘ Â¡LEYENDA DE LOS HÃBITOS!';
          
          message += specialMsg;
          sendTelegramMessage(message);
          sendBrowserNotification(`${habit.emoji} Â¡${username} completÃ³ un hÃ¡bito!`, `${habit.name} - Racha: ${newStreak} dÃ­a${newStreak !== 1 ? 's' : ''} ğŸ”¥${specialMsg.replace('\n', ' ')}`, habit.emoji);
        }
      };

      const isCompletedToday = (habit) => {
        if (!habit.lastCompleted) return false;
        return new Date().toDateString() === new Date(habit.lastCompleted).toDateString();
      };

      if (loading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-900 via-purple-700 to-pink-600 flex items-center justify-center">
            <div className="text-white text-2xl">Cargando...</div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-900 via-purple-700 to-pink-600 p-4 md:p-8">
          {showNotificationPrompt && (
            <div className="fixed top-4 right-4 z-50 bg-white rounded-2xl p-6 shadow-2xl max-w-sm animate-bounce">
              <div className="flex items-start gap-4">
                <div className="text-4xl">ğŸ””</div>
                <div className="flex-1">
                  <h3 className="font-bold text-gray-800 mb-2">Â¿Activar notificaciones?</h3>
                  <p className="text-sm text-gray-600 mb-4">Recibe alertas cuando tÃº o tu amigo completen hÃ¡bitos</p>
                  <div className="flex gap-2">
                    <button onClick={requestNotificationPermission} className="flex-1 py-2 px-4 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 text-sm">Activar</button>
                    <button onClick={() => setShowNotificationPrompt(false)} className="flex-1 py-2 px-4 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 text-sm">Ahora no</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {showUsernameModal && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl">
                <div className="text-center mb-6">
                  <div className="text-6xl mb-4">ğŸ‘¤</div>
                  <h2 className="text-3xl font-bold text-gray-800 mb-2">Â¡Bienvenido!</h2>
                  <p className="text-gray-600">Â¿CÃ³mo te llamas?</p>
                </div>
                <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && saveUsername()} placeholder="Tu nombre..." className="w-full px-6 py-4 rounded-xl border-2 border-purple-300 focus:border-purple-500 focus:outline-none text-lg mb-4" autoFocus />
                <button onClick={saveUsername} className="w-full py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-semibold hover:from-purple-600 hover:to-pink-600 transition-all">Comenzar</button>
              </div>
            </div>
          )}

          {showCelebration && (
            <div className="fixed inset-0 flex items-center justify-center z-50 pointer-events-none">
              <div className="bg-white/90 backdrop-blur-sm rounded-3xl p-8 shadow-2xl animate-bounce">
                <img src={celebrationGif} alt="Celebration" className="w-64 h-64 rounded-2xl object-cover" />
                <div className="text-4xl font-bold text-center mt-4 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Â¡Genial! ğŸ‰</div>
              </div>
            </div>
          )}

          {showShame && (
            <div className="fixed inset-0 flex items-center justify-center z-50 pointer-events-none">
              <div className="bg-white/90 backdrop-blur-sm rounded-3xl p-8 shadow-2xl animate-bounce">
                <img src={shameGif} alt="Shame" className="w-64 h-64 rounded-2xl object-cover" />
                <div className="text-4xl font-bold text-center mt-4 text-red-600">Â¡Te saltaste dÃ­as! ğŸ˜¢</div>
              </div>
            </div>
          )}

          <div className="max-w-4xl mx-auto">
            <div className="text-center mb-8">
              <div className="flex items-center justify-center gap-4 mb-2">
                <h1 className="text-5xl font-bold text-white drop-shadow-lg">Habit Tracker Pro</h1>
                <button onClick={requestNotificationPermission} className={`p-3 rounded-xl transition-all ${notificationsEnabled ? 'bg-green-500/20 text-green-300' : 'bg-white/10 text-white hover:bg-white/20'}`} title={notificationsEnabled ? 'Notificaciones activadas' : 'Activar notificaciones'}>
                  {notificationsEnabled ? 'ğŸ””' : 'ğŸ”•'}
                </button>
              </div>
              <p className="text-purple-200 text-lg">ğŸ‘¤ {username}</p>
            </div>

            <div className="bg-white/10 backdrop-blur-md rounded-2xl p-6 mb-6 shadow-xl">
              <div className="mb-4">
                <label className="text-white text-sm mb-2 block">Elige un emoji:</label>
                <div className="flex flex-wrap gap-2 mb-4">
                  {EMOJIS.map(emoji => (
                    <button key={emoji} onClick={() => setSelectedEmoji(emoji)} className={`text-3xl p-2 rounded-lg transition-all ${selectedEmoji === emoji ? 'bg-white/30 scale-125' : 'bg-white/10 hover:bg-white/20'}`}>{emoji}</button>
                  ))}
                </div>
              </div>
              <div className="flex gap-3">
                <input type="text" value={newHabit} onChange={(e) => setNewHabit(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && addHabit()} placeholder="Nuevo hÃ¡bito..." className="flex-1 px-6 py-4 rounded-xl bg-white/20 backdrop-blur-sm text-white placeholder-purple-200 border-2 border-white/30 focus:border-white/60 focus:outline-none text-lg" />
                <button onClick={addHabit} className="px-8 py-4 bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-xl font-semibold hover:from-pink-600 hover:to-purple-600 transition-all transform hover:scale-105 shadow-lg">â• Agregar</button>
              </div>
            </div>

            <div className="space-y-4">
              {habits.length === 0 ? (
                <div className="bg-white/10 backdrop-blur-md rounded-2xl p-12 text-center shadow-xl">
                  <p className="text-purple-200 text-xl">No hay hÃ¡bitos aÃºn. Â¡Agrega tu primer hÃ¡bito! ğŸš€</p>
                </div>
              ) : habits.map((habit) => {
                const completed = isCompletedToday(habit);
                return (
                  <div key={habit.id} className={`bg-white/10 backdrop-blur-md rounded-2xl p-6 shadow-xl transition-all transform hover:scale-[1.02] ${completed ? 'bg-green-500/20 border-2 border-green-400/50' : ''}`}>
                    <div className="flex items-center justify-between">
                      <div className="flex-1 flex items-center gap-4">
                        <span className="text-5xl">{habit.emoji}</span>
                        <div>
                          <h3 className={`text-2xl font-semibold mb-2 ${completed ? 'text-green-300 line-through' : 'text-white'}`}>{habit.name}</h3>
                          <div className="flex gap-6 text-purple-200">
                            <span>âœ“ {habit.completedCount} veces</span>
                            <span>ğŸ”¥ {habit.streak} dÃ­as seguidos</span>
                          </div>
                        </div>
                      </div>
                      <div className="flex gap-3">
                        <button onClick={() => completeHabit(habit.id)} disabled={completed} className={`p-4 rounded-xl font-semibold transition-all transform hover:scale-110 shadow-lg ${completed ? 'bg-green-500/50 text-green-200 cursor-not-allowed' : 'bg-gradient-to-r from-green-400 to-emerald-500 text-white hover:from-green-500 hover:to-emerald-600'}`}>âœ“</button>
                        <button onClick={() => deleteHabit(habit.id)} className="p-4 bg-red-500/20 hover:bg-red-500/40 text-red-300 rounded-xl transition-all transform hover:scale-110">ğŸ—‘ï¸</button>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>

            {habits.length > 0 && (
              <div className="mt-8 bg-white/10 backdrop-blur-md rounded-2xl p-6 shadow-xl">
                <h2 className="text-2xl font-bold text-white mb-4">ğŸ“Š EstadÃ­sticas</h2>
                <div className="grid grid-cols-3 gap-4">
                  <div className="text-center"><div className="text-4xl font-bold text-white">{habits.length}</div><div className="text-purple-200">HÃ¡bitos</div></div>
                  <div className="text-center"><div className="text-4xl font-bold text-white">{habits.reduce((s, h) => s + h.completedCount, 0)}</div><div className="text-purple-200">Total</div></div>
                  <div className="text-center"><div className="text-4xl font-bold text-white">{habits.filter(isCompletedToday).length}</div><div className="text-purple-200">Hoy</div></div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }
    
    ReactDOM.render(<HabitTracker />, document.getElementById('root'));
  </script>
</body>
</html>
